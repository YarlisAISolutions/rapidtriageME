# Cloudflare Workers configuration for RapidTriageME
# Configuration for rapidtriage.me domain

name = "rapidtriage-me"
main = "src/worker.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Account details
account_id = "ed3fbe9532564f2f06ae772da689431a"
workers_dev = false

# Custom domain configuration
routes = [
  { pattern = "rapidtriage.me/*", zone_id = "dba0cbc72f7f0b7727fbdb6f4d6d7901" },
  { pattern = "www.rapidtriage.me/*", zone_id = "dba0cbc72f7f0b7727fbdb6f4d6d7901" }
]

# Environment variables for production (non-sensitive)
[vars]
ENVIRONMENT = "production"
BROWSER_TOOLS_PORT = "3025"
SSE_ENDPOINT = "/sse"
HEALTH_ENDPOINT = "/health"
METRICS_ENDPOINT = "/metrics"

# Secrets (set using wrangler secret put)
# RAPIDTRIAGE_API_TOKEN - API authentication token
# AUTH_TOKEN - Internal auth token
# JWT_SECRET - JWT signing secret
# CLOUDFLARE_API_TOKEN - Cloudflare API token

# KV namespace for session storage
[[kv_namespaces]]
binding = "SESSIONS"
id = "5926c0732c074d23b7ea3941fd1c6836"

# R2 bucket for screenshot storage
[[r2_buckets]]
binding = "SCREENSHOTS"
bucket_name = "rapidtriage-screenshots"

# Durable Objects for WebSocket connections
[[durable_objects.bindings]]
name = "BROWSER_SESSIONS"
class_name = "BrowserSession"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["BrowserSession"]

# Build configuration
[build]
command = "npm run build"

# Development environment
[env.development]
name = "rapidtriage-dev"
workers_dev = true
vars = { ENVIRONMENT = "development" }

# Staging environment
[env.staging]
name = "rapidtriage-staging"
workers_dev = true

[env.staging.vars]
ENVIRONMENT = "staging"
BROWSER_TOOLS_PORT = "3025"
SSE_ENDPOINT = "/sse"
HEALTH_ENDPOINT = "/health"
METRICS_ENDPOINT = "/metrics"
LOG_LEVEL = "debug"

[[env.staging.kv_namespaces]]
binding = "SESSIONS"
id = "5926c0732c074d23b7ea3941fd1c6836"

[[env.staging.durable_objects.bindings]]
name = "BROWSER_SESSIONS"
class_name = "BrowserSession"

# Production environment
[env.production]
name = "rapidtriage-me-production"
workers_dev = false

[[env.production.routes]]
pattern = "rapidtriage.me/*"
zone_id = "dba0cbc72f7f0b7727fbdb6f4d6d7901"

[[env.production.routes]]
pattern = "www.rapidtriage.me/*"
zone_id = "dba0cbc72f7f0b7727fbdb6f4d6d7901"

[[env.production.routes]]
pattern = "test.rapidtriage.me/*"
zone_id = "dba0cbc72f7f0b7727fbdb6f4d6d7901"

[env.production.vars]
ENVIRONMENT = "production"
BROWSER_TOOLS_PORT = "3025"
SSE_ENDPOINT = "/sse"
HEALTH_ENDPOINT = "/health"
METRICS_ENDPOINT = "/metrics"
LOG_LEVEL = "error"
DEPLOYMENT_TIMESTAMP = "2025-08-10T20:04:58Z"

[[env.production.kv_namespaces]]
binding = "SESSIONS"
id = "5926c0732c074d23b7ea3941fd1c6836"

[[env.production.r2_buckets]]
binding = "SCREENSHOTS"
bucket_name = "rapidtriage-screenshots"

[[env.production.durable_objects.bindings]]
name = "BROWSER_SESSIONS"
class_name = "BrowserSession"