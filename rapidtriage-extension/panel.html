<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
        }
        
        h1 {
            color: #4CAF50;
            margin: 0 0 20px 0;
            font-size: 18px;
        }
        
        .status {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .log {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            background: #007ACC;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        button:active {
            background: #004080;
            transform: scale(0.98);
        }
        
        button.loading {
            background: #888;
            cursor: wait;
            position: relative;
            color: transparent;
        }
        
        button.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #007ACC;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üöÄ RapidTriage DevTools Panel</h1>
    
    <div class="status">
        <div>‚úÖ Panel loaded successfully!</div>
        <div>Time: <span id="time"></span></div>
        <div>Chrome: <span id="chrome-version"></span></div>
    </div>
    
    <button onclick="testServer(this)">Test Server</button>
    <button onclick="takeScreenshot(this)">Screenshot</button>
    <button onclick="clearLogs(this)">Clear</button>
    <button onclick="openDevTools(this)">Open DevTools</button>
    
    <br><br>
    
    <button onclick="runLighthouseAudit(this)">Lighthouse Audit</button>
    <button onclick="getConsoleLogs(this)">Console Logs</button>
    <button onclick="inspectElement(this)">Inspect Element</button>
    
    <div id="logs"></div>
    
    <script>
        // Initialize
        document.getElementById('time').textContent = new Date().toLocaleString();
        
        const chromeVersion = navigator.userAgent.match(/Chrome\/(\d+)/);
        document.getElementById('chrome-version').textContent = chromeVersion ? chromeVersion[1] : 'Unknown';
        
        // Function to determine the correct API base URL
        function getApiBaseUrl(url) {
            // Check if URL is local development
            if (!url || 
                url.startsWith('http://localhost') || 
                url.startsWith('http://127.0.0.1') || 
                url.startsWith('file://') ||
                url.startsWith('chrome://') ||
                url.startsWith('chrome-extension://')) {
                // Use local server for local development
                return 'http://localhost:3025';
            }
            // Use remote server for all other URLs
            return 'https://rapidtriage.me';
        }
        
        // Function to test connection with fallback
        async function fetchWithFallback(primaryUrl, fallbackUrl, options = {}) {
            try {
                const response = await fetch(primaryUrl, { ...options, timeout: 5000 });
                if (response.ok) {
                    return { response, usedUrl: primaryUrl };
                }
                throw new Error(`Server returned ${response.status}`);
            } catch (primaryError) {
                console.log(`Primary server failed (${primaryUrl}):`, primaryError.message);
                if (fallbackUrl && fallbackUrl !== primaryUrl) {
                    try {
                        console.log(`Trying fallback server (${fallbackUrl})...`);
                        const response = await fetch(fallbackUrl, options);
                        if (response.ok) {
                            return { response, usedUrl: fallbackUrl };
                        }
                    } catch (fallbackError) {
                        console.log(`Fallback server also failed:`, fallbackError.message);
                    }
                }
                throw primaryError;
            }
        }
        
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.insertBefore(logDiv, logs.firstChild);
        }
        
        function setButtonLoading(buttonElement, loading = true) {
            if (!buttonElement) return;
            
            if (loading) {
                buttonElement.classList.add('loading');
                buttonElement.disabled = true;
                buttonElement.setAttribute('data-original-text', buttonElement.textContent);
            } else {
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
                const originalText = buttonElement.getAttribute('data-original-text');
                if (originalText) {
                    buttonElement.textContent = originalText;
                }
            }
        }
        
        async function testServer(button) {
            if (button) setButtonLoading(button, true);
            addLog('Testing server connection...');
            
            try {
                // Get current URL
                const currentUrl = window.location?.href || '';
                const primaryUrl = getApiBaseUrl(currentUrl);
                const fallbackUrl = primaryUrl === 'http://localhost:3025' 
                    ? 'https://rapidtriage.me' 
                    : 'http://localhost:3025';
                
                const { response, usedUrl } = await fetchWithFallback(
                    `${primaryUrl}/.identity`,
                    `${fallbackUrl}/.identity`
                );
                
                const data = await response.json();
                addLog(`‚úÖ Connected to ${usedUrl}: ${data.name} v${data.version}`);
                
            } catch (error) {
                addLog(`‚ùå Connection failed: ${error.message}`);
            } finally {
                if (button) setButtonLoading(button, false);
            }
        }
        
        function clearLogs(button) {
            if (button) setButtonLoading(button, true);
            document.getElementById('logs').innerHTML = '';
            addLog('Logs cleared');
            
            setTimeout(() => {
                if (button) setButtonLoading(button, false);
            }, 300);
        }
        
        function takeScreenshot() {
            addLog('üì∑ Taking screenshot...');
            
            // For DevTools panel, we need to use the inspected window
            const tabId = chrome.devtools.inspectedWindow.tabId;
            
            chrome.runtime.sendMessage({
                type: 'CAPTURE_SCREENSHOT',
                tabId: tabId
            }, function(response) {
                if (chrome.runtime.lastError) {
                    addLog(`‚ùå Screenshot failed: ${chrome.runtime.lastError.message}`);
                } else if (response && response.success) {
                    addLog('‚úÖ Screenshot captured and sent to server');
                    addLog(`üìÅ Saved as: ${response.path || 'screenshot.png'}`);
                } else {
                    addLog(`‚ùå Screenshot failed: ${response?.error || 'Unknown error'}`);
                }
            });
        }
        
        function openDevTools() {
            addLog('Opening DevTools...');
            chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                chrome.debugger.attach({tabId: tabs[0].id}, '1.0', function() {
                    if (chrome.runtime.lastError) {
                        addLog(`‚ùå DevTools failed: ${chrome.runtime.lastError.message}`);
                    } else {
                        addLog('‚úÖ DevTools opened (press F12 to see)');
                    }
                });
            });
        }
        
        async function runLighthouseAudit() {
            addLog('üîç Starting Lighthouse audit...');
            
            try {
                // Get URL from inspected window
                const currentUrl = window.location?.href || '';
                addLog(`üìä Auditing: ${currentUrl}`);
                
                // Determine API endpoint based on URL
                const apiBaseUrl = getApiBaseUrl(currentUrl);
                const fallbackUrl = apiBaseUrl === 'http://localhost:3025' 
                    ? 'https://rapidtriage.me' 
                    : 'http://localhost:3025';
                
                addLog(`üîó Using API: ${apiBaseUrl}`);
                
                const { response, usedUrl } = await fetchWithFallback(
                    `${apiBaseUrl}/api/lighthouse`,
                    `${fallbackUrl}/api/lighthouse`,
                    {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({url: currentUrl})
                    }
                );
                
                addLog(`‚úÖ Connected to: ${usedUrl}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const scores = data.data.scores;
                    const metrics = data.data.metrics;
                    
                    addLog('‚úÖ Lighthouse Audit Complete:');
                    addLog(`  üèÉ Performance: ${scores.performance}/100`);
                    addLog(`  ‚ôø Accessibility: ${scores.accessibility}/100`);
                    addLog(`  üéØ Best Practices: ${scores.bestPractices}/100`);
                    addLog(`  üîç SEO: ${scores.seo}/100`);
                    addLog(`  ‚è±Ô∏è Load Time: ${metrics.loadTime}ms`);
                } else {
                    addLog(`‚ùå Lighthouse failed: ${data.error}`);
                }
            } catch (error) {
                addLog(`‚ùå Lighthouse error: ${error.message}`);
                addLog(`üí° Tip: Check if server is accessible`);
            }
        }
        
        async function getConsoleLogs() {
            addLog('üìã Getting console logs...');
            
            try {
                // Get URL from inspected window
                const currentUrl = window.location?.href || '';
                addLog(`üîç Analyzing console logs for: ${currentUrl}`);
                
                // Determine API endpoint based on URL
                const apiBaseUrl = getApiBaseUrl(currentUrl);
                const fallbackUrl = apiBaseUrl === 'http://localhost:3025' 
                    ? 'https://rapidtriage.me' 
                    : 'http://localhost:3025';
                
                addLog(`üîó Using API: ${apiBaseUrl}`);
                
                const { response, usedUrl } = await fetchWithFallback(
                    `${apiBaseUrl}/api/console-logs`,
                    `${fallbackUrl}/api/console-logs`,
                    {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({url: currentUrl})
                    }
                );
                
                addLog(`‚úÖ Connected to: ${usedUrl}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const logs = data.data.logs;
                    addLog(`‚úÖ Found ${logs.length} console entries:`);
                    
                    if (logs.length === 0) {
                        addLog('  üìù No console messages found');
                    } else {
                        // Group by log level
                        const byLevel = logs.reduce((acc, log) => {
                            acc[log.level] = (acc[log.level] || 0) + 1;
                            return acc;
                        }, {});
                        
                        Object.entries(byLevel).forEach(([level, count]) => {
                            const emoji = level === 'error' ? '‚ùå' : level === 'warn' ? '‚ö†Ô∏è' : level === 'info' ? '‚ÑπÔ∏è' : 'üìù';
                            addLog(`  ${emoji} ${level}: ${count} messages`);
                        });
                        
                        // Show last few messages
                        addLog('  üìÉ Recent messages:');
                        logs.slice(-5).forEach(log => {
                            const emoji = log.level === 'error' ? '‚ùå' : log.level === 'warn' ? '‚ö†Ô∏è' : 'üìù';
                            addLog(`    ${emoji} ${log.text.substring(0, 60)}${log.text.length > 60 ? '...' : ''}`);
                        });
                    }
                } else {
                    addLog(`‚ùå Console logs failed: ${data.error}`);
                }
            } catch (error) {
                addLog(`‚ùå Console logs error: ${error.message}`);
                addLog(`üí° Tip: Check if server is accessible`);
            }
        }
        
        function inspectElement() {
            addLog('Element inspection ready - select an element on the page');
            chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                addLog('üí° Click on any element on the page to inspect it');
            });
        }
        
        // Initial log
        addLog('RapidTriage panel initialized');
        
        // Auto test server
        setTimeout(testServer, 500);
    </script>
</body>
</html>